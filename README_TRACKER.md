
# Tools Pack — Tracker Add‑On (Netlify Functions + Supabase)

This folder adds **per‑visitor tracking** to your static site with:
- A lightweight **frontend tracker** (`/assets/tracker.js`)
- **Serverless backend** on Netlify (`/netlify/functions/*`)
- A simple **Admin dashboard** (`/admin/`) with login

> Privacy: IP addresses are **hashed** with a salt and never stored raw.

---

## 1) What you need
- Your site deployed on **Netlify**.
- A free **Supabase** project (Postgres + REST).

### Create table (run in Supabase SQL editor)
```sql
create table if not exists public.events (
  id bigint generated by default as identity primary key,
  site_id text not null,
  session_id uuid,
  user_id text,
  ip_hash text,
  user_agent text,
  referrer text,
  url text,
  path text,
  event_type text not null default 'pageview',
  meta jsonb default '{}'::jsonb,
  ts timestamptz not null default now()
);

-- Helpful index
create index if not exists events_ts_idx on public.events (ts desc);
create index if not exists events_path_idx on public.events (path);
create index if not exists events_site_ts_idx on public.events (site_id, ts desc);
```

> No Row Level Security is enabled by default when using the **service role** from serverless functions.

---

## 2) Add these files to your project
Copy the folders in this ZIP into the **root** of your Tools Pack project:
```
/assets/tracker.js
/admin/index.html
/admin/admin.css
/admin/admin.js
/netlify/functions/_common.js
/netlify/functions/log.js
/netlify/functions/admin-login.js
/netlify/functions/admin-events.js
/netlify/functions/admin-stats.js
```

If you already have `/assets`, just **merge**.

---

## 3) Netlify configuration
Set **Environment Variables** in Netlify (Site → Settings → Build & deploy → Environment):
- `SUPABASE_URL` → e.g. `https://YOUR-PROJECT.supabase.co`
- `SUPABASE_SERVICE_ROLE` → from Supabase Project Settings → API → *Service role key*
- `SITE_ID` → any label for this website, e.g. `tools-pack`
- `ADMIN_PASSWORD` → a strong password you'll use to log into the admin
- `ADMIN_SECRET` → any random long string (used to sign tokens)
- `IP_SALT` → any random string (used to hash IPs)

> Re‑deploy after setting env vars.

Optionally, add to your `netlify.toml` (if you don't already have one):
```toml
[functions]
  node_bundler = "esbuild"
```

---

## 4) Include the tracker on every page
Add **before `</body>`** in all HTML pages (or in your shared layout/header include):
```html
<script src="/assets/tracker.js" defer data-trk-site="tools-pack"></script>
```

That's it. It will send **pageviews** and **link clicks** to `/.netlify/functions/log`.

---

## 5) Open the Admin
Visit `/admin/` on your site, enter the **ADMIN_PASSWORD**, and see:
- Pageviews & total events
- Top pages and referrers
- Recent events (time, type, path, referrer)

> The admin uses a short‑lived token signed with `ADMIN_SECRET`. No third‑party auth needed.

---

## 6) Extending (optional)
- Track custom events:
  ```js
  window.tpTrack && window.tpTrack('download', { file: 'brochure.pdf' });
  ```
  You can add this call anywhere on your pages; just expose it in `tracker.js` if needed.
- Add charts (Chart.js) or filters in `/admin/`.
- Add **user login integration** later: send your app's `userId` in the payload.

---

## 7) Notes
- This solution is **Netlify + Supabase** only; no Prisma required.
- If you ever migrate off Netlify, you can reuse the same functions as a simple Express server.
- Keep the **service role key** only on the serverless side; **never** expose it in client code.
